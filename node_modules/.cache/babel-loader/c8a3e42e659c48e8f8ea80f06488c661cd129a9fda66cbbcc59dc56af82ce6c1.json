{"ast":null,"code":"/*\n\tMIT License http://www.opensource.org/licenses/mit-license.php\n\tAuthor Tobias Koppers @sokra\n*/\n\n\"use strict\";\n\nconst RuntimeGlobals = require(\"../RuntimeGlobals\");\nconst RuntimeModule = require(\"../RuntimeModule\");\nconst Template = require(\"../Template\");\nconst {\n  compareModulesByIdentifier,\n  compareStrings\n} = require(\"../util/comparators\");\n\n/** @typedef {import(\"../Chunk\")} Chunk */\n/** @typedef {import(\"../ChunkGraph\")} ChunkGraph */\n/** @typedef {import(\"../Compilation\")} Compilation */\n\nclass ShareRuntimeModule extends RuntimeModule {\n  constructor() {\n    super(\"sharing\");\n  }\n\n  /**\n   * @returns {string | null} runtime code\n   */\n  generate() {\n    const compilation = /** @type {Compilation} */this.compilation;\n    const {\n      runtimeTemplate,\n      codeGenerationResults,\n      outputOptions: {\n        uniqueName,\n        ignoreBrowserWarnings\n      }\n    } = compilation;\n    const chunkGraph = /** @type {ChunkGraph} */this.chunkGraph;\n    /** @type {Map<string, Map<number, Set<string>>>} */\n    const initCodePerScope = new Map();\n    for (const chunk of /** @type {Chunk} */this.chunk.getAllReferencedChunks()) {\n      const modules = chunkGraph.getOrderedChunkModulesIterableBySourceType(chunk, \"share-init\", compareModulesByIdentifier);\n      if (!modules) continue;\n      for (const m of modules) {\n        const data = codeGenerationResults.getData(m, chunk.runtime, \"share-init\");\n        if (!data) continue;\n        for (const item of data) {\n          const {\n            shareScope,\n            initStage,\n            init\n          } = item;\n          let stages = initCodePerScope.get(shareScope);\n          if (stages === undefined) {\n            initCodePerScope.set(shareScope, stages = new Map());\n          }\n          let list = stages.get(initStage || 0);\n          if (list === undefined) {\n            stages.set(initStage || 0, list = new Set());\n          }\n          list.add(init);\n        }\n      }\n    }\n    return Template.asString([`${RuntimeGlobals.shareScopeMap} = {};`, \"var initPromises = {};\", \"var initTokens = {};\", `${RuntimeGlobals.initializeSharing} = ${runtimeTemplate.basicFunction(\"name, initScope\", [\"if(!initScope) initScope = [];\", \"// handling circular init calls\", \"var initToken = initTokens[name];\", \"if(!initToken) initToken = initTokens[name] = {};\", \"if(initScope.indexOf(initToken) >= 0) return;\", \"initScope.push(initToken);\", \"// only runs once\", \"if(initPromises[name]) return initPromises[name];\", \"// creates a new share scope if needed\", `if(!${RuntimeGlobals.hasOwnProperty}(${RuntimeGlobals.shareScopeMap}, name)) ${RuntimeGlobals.shareScopeMap}[name] = {};`, \"// runs all init snippets from all modules reachable\", `var scope = ${RuntimeGlobals.shareScopeMap}[name];`, `var warn = ${ignoreBrowserWarnings ? runtimeTemplate.basicFunction(\"\", \"\") : runtimeTemplate.basicFunction(\"msg\", ['if (typeof console !== \"undefined\" && console.warn) console.warn(msg);'])};`, `var uniqueName = ${JSON.stringify(uniqueName || undefined)};`, `var register = ${runtimeTemplate.basicFunction(\"name, version, factory, eager\", [\"var versions = scope[name] = scope[name] || {};\", \"var activeVersion = versions[version];\", \"if(!activeVersion || (!activeVersion.loaded && (!eager != !activeVersion.eager ? eager : uniqueName > activeVersion.from))) versions[version] = { get: factory, from: uniqueName, eager: !!eager };\"])};`, `var initExternal = ${runtimeTemplate.basicFunction(\"id\", [`var handleError = ${runtimeTemplate.expressionFunction('warn(\"Initialization of sharing external failed: \" + err)', \"err\")};`, \"try {\", Template.indent([`var module = ${RuntimeGlobals.require}(id);`, \"if(!module) return;\", `var initFn = ${runtimeTemplate.returningFunction(`module && module.init && module.init(${RuntimeGlobals.shareScopeMap}[name], initScope)`, \"module\")}`, \"if(module.then) return promises.push(module.then(initFn, handleError));\", \"var initResult = initFn(module);\", \"if(initResult && initResult.then) return promises.push(initResult['catch'](handleError));\"]), \"} catch(err) { handleError(err); }\"])}`, \"var promises = [];\", \"switch(name) {\", ...Array.from(initCodePerScope).sort(([a], [b]) => compareStrings(a, b)).map(([name, stages]) => Template.indent([`case ${JSON.stringify(name)}: {`, Template.indent(Array.from(stages).sort(([a], [b]) => a - b).map(([, initCode]) => Template.asString(Array.from(initCode)))), \"}\", \"break;\"])), \"}\", \"if(!promises.length) return initPromises[name] = 1;\", `return initPromises[name] = Promise.all(promises).then(${runtimeTemplate.returningFunction(\"initPromises[name] = 1\")});`])};`]);\n  }\n}\nmodule.exports = ShareRuntimeModule;","map":{"version":3,"names":["RuntimeGlobals","require","RuntimeModule","Template","compareModulesByIdentifier","compareStrings","ShareRuntimeModule","constructor","generate","compilation","runtimeTemplate","codeGenerationResults","outputOptions","uniqueName","ignoreBrowserWarnings","chunkGraph","initCodePerScope","Map","chunk","getAllReferencedChunks","modules","getOrderedChunkModulesIterableBySourceType","m","data","getData","runtime","item","shareScope","initStage","init","stages","get","undefined","set","list","Set","add","asString","shareScopeMap","initializeSharing","basicFunction","hasOwnProperty","JSON","stringify","expressionFunction","indent","returningFunction","Array","from","sort","a","b","map","name","initCode","module","exports"],"sources":["/Volumes/storage/projects/project-mcnt/node_modules/webpack/lib/sharing/ShareRuntimeModule.js"],"sourcesContent":["/*\n\tMIT License http://www.opensource.org/licenses/mit-license.php\n\tAuthor Tobias Koppers @sokra\n*/\n\n\"use strict\";\n\nconst RuntimeGlobals = require(\"../RuntimeGlobals\");\nconst RuntimeModule = require(\"../RuntimeModule\");\nconst Template = require(\"../Template\");\nconst {\n\tcompareModulesByIdentifier,\n\tcompareStrings\n} = require(\"../util/comparators\");\n\n/** @typedef {import(\"../Chunk\")} Chunk */\n/** @typedef {import(\"../ChunkGraph\")} ChunkGraph */\n/** @typedef {import(\"../Compilation\")} Compilation */\n\nclass ShareRuntimeModule extends RuntimeModule {\n\tconstructor() {\n\t\tsuper(\"sharing\");\n\t}\n\n\t/**\n\t * @returns {string | null} runtime code\n\t */\n\tgenerate() {\n\t\tconst compilation = /** @type {Compilation} */ (this.compilation);\n\t\tconst {\n\t\t\truntimeTemplate,\n\t\t\tcodeGenerationResults,\n\t\t\toutputOptions: { uniqueName, ignoreBrowserWarnings }\n\t\t} = compilation;\n\t\tconst chunkGraph = /** @type {ChunkGraph} */ (this.chunkGraph);\n\t\t/** @type {Map<string, Map<number, Set<string>>>} */\n\t\tconst initCodePerScope = new Map();\n\t\tfor (const chunk of /** @type {Chunk} */ (\n\t\t\tthis.chunk\n\t\t).getAllReferencedChunks()) {\n\t\t\tconst modules = chunkGraph.getOrderedChunkModulesIterableBySourceType(\n\t\t\t\tchunk,\n\t\t\t\t\"share-init\",\n\t\t\t\tcompareModulesByIdentifier\n\t\t\t);\n\t\t\tif (!modules) continue;\n\t\t\tfor (const m of modules) {\n\t\t\t\tconst data = codeGenerationResults.getData(\n\t\t\t\t\tm,\n\t\t\t\t\tchunk.runtime,\n\t\t\t\t\t\"share-init\"\n\t\t\t\t);\n\t\t\t\tif (!data) continue;\n\t\t\t\tfor (const item of data) {\n\t\t\t\t\tconst { shareScope, initStage, init } = item;\n\t\t\t\t\tlet stages = initCodePerScope.get(shareScope);\n\t\t\t\t\tif (stages === undefined) {\n\t\t\t\t\t\tinitCodePerScope.set(shareScope, (stages = new Map()));\n\t\t\t\t\t}\n\t\t\t\t\tlet list = stages.get(initStage || 0);\n\t\t\t\t\tif (list === undefined) {\n\t\t\t\t\t\tstages.set(initStage || 0, (list = new Set()));\n\t\t\t\t\t}\n\t\t\t\t\tlist.add(init);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Template.asString([\n\t\t\t`${RuntimeGlobals.shareScopeMap} = {};`,\n\t\t\t\"var initPromises = {};\",\n\t\t\t\"var initTokens = {};\",\n\t\t\t`${RuntimeGlobals.initializeSharing} = ${runtimeTemplate.basicFunction(\n\t\t\t\t\"name, initScope\",\n\t\t\t\t[\n\t\t\t\t\t\"if(!initScope) initScope = [];\",\n\t\t\t\t\t\"// handling circular init calls\",\n\t\t\t\t\t\"var initToken = initTokens[name];\",\n\t\t\t\t\t\"if(!initToken) initToken = initTokens[name] = {};\",\n\t\t\t\t\t\"if(initScope.indexOf(initToken) >= 0) return;\",\n\t\t\t\t\t\"initScope.push(initToken);\",\n\t\t\t\t\t\"// only runs once\",\n\t\t\t\t\t\"if(initPromises[name]) return initPromises[name];\",\n\t\t\t\t\t\"// creates a new share scope if needed\",\n\t\t\t\t\t`if(!${RuntimeGlobals.hasOwnProperty}(${RuntimeGlobals.shareScopeMap}, name)) ${RuntimeGlobals.shareScopeMap}[name] = {};`,\n\t\t\t\t\t\"// runs all init snippets from all modules reachable\",\n\t\t\t\t\t`var scope = ${RuntimeGlobals.shareScopeMap}[name];`,\n\t\t\t\t\t`var warn = ${\n\t\t\t\t\t\tignoreBrowserWarnings\n\t\t\t\t\t\t\t? runtimeTemplate.basicFunction(\"\", \"\")\n\t\t\t\t\t\t\t: runtimeTemplate.basicFunction(\"msg\", [\n\t\t\t\t\t\t\t\t\t'if (typeof console !== \"undefined\" && console.warn) console.warn(msg);'\n\t\t\t\t\t\t\t\t])\n\t\t\t\t\t};`,\n\t\t\t\t\t`var uniqueName = ${JSON.stringify(uniqueName || undefined)};`,\n\t\t\t\t\t`var register = ${runtimeTemplate.basicFunction(\n\t\t\t\t\t\t\"name, version, factory, eager\",\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t\"var versions = scope[name] = scope[name] || {};\",\n\t\t\t\t\t\t\t\"var activeVersion = versions[version];\",\n\t\t\t\t\t\t\t\"if(!activeVersion || (!activeVersion.loaded && (!eager != !activeVersion.eager ? eager : uniqueName > activeVersion.from))) versions[version] = { get: factory, from: uniqueName, eager: !!eager };\"\n\t\t\t\t\t\t]\n\t\t\t\t\t)};`,\n\t\t\t\t\t`var initExternal = ${runtimeTemplate.basicFunction(\"id\", [\n\t\t\t\t\t\t`var handleError = ${runtimeTemplate.expressionFunction(\n\t\t\t\t\t\t\t'warn(\"Initialization of sharing external failed: \" + err)',\n\t\t\t\t\t\t\t\"err\"\n\t\t\t\t\t\t)};`,\n\t\t\t\t\t\t\"try {\",\n\t\t\t\t\t\tTemplate.indent([\n\t\t\t\t\t\t\t`var module = ${RuntimeGlobals.require}(id);`,\n\t\t\t\t\t\t\t\"if(!module) return;\",\n\t\t\t\t\t\t\t`var initFn = ${runtimeTemplate.returningFunction(\n\t\t\t\t\t\t\t\t`module && module.init && module.init(${RuntimeGlobals.shareScopeMap}[name], initScope)`,\n\t\t\t\t\t\t\t\t\"module\"\n\t\t\t\t\t\t\t)}`,\n\t\t\t\t\t\t\t\"if(module.then) return promises.push(module.then(initFn, handleError));\",\n\t\t\t\t\t\t\t\"var initResult = initFn(module);\",\n\t\t\t\t\t\t\t\"if(initResult && initResult.then) return promises.push(initResult['catch'](handleError));\"\n\t\t\t\t\t\t]),\n\t\t\t\t\t\t\"} catch(err) { handleError(err); }\"\n\t\t\t\t\t])}`,\n\t\t\t\t\t\"var promises = [];\",\n\t\t\t\t\t\"switch(name) {\",\n\t\t\t\t\t...Array.from(initCodePerScope)\n\t\t\t\t\t\t.sort(([a], [b]) => compareStrings(a, b))\n\t\t\t\t\t\t.map(([name, stages]) =>\n\t\t\t\t\t\t\tTemplate.indent([\n\t\t\t\t\t\t\t\t`case ${JSON.stringify(name)}: {`,\n\t\t\t\t\t\t\t\tTemplate.indent(\n\t\t\t\t\t\t\t\t\tArray.from(stages)\n\t\t\t\t\t\t\t\t\t\t.sort(([a], [b]) => a - b)\n\t\t\t\t\t\t\t\t\t\t.map(([, initCode]) =>\n\t\t\t\t\t\t\t\t\t\t\tTemplate.asString(Array.from(initCode))\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\"}\",\n\t\t\t\t\t\t\t\t\"break;\"\n\t\t\t\t\t\t\t])\n\t\t\t\t\t\t),\n\t\t\t\t\t\"}\",\n\t\t\t\t\t\"if(!promises.length) return initPromises[name] = 1;\",\n\t\t\t\t\t`return initPromises[name] = Promise.all(promises).then(${runtimeTemplate.returningFunction(\n\t\t\t\t\t\t\"initPromises[name] = 1\"\n\t\t\t\t\t)});`\n\t\t\t\t]\n\t\t\t)};`\n\t\t]);\n\t}\n}\n\nmodule.exports = ShareRuntimeModule;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}